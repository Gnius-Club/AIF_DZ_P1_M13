<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Jard√≠n de los Ecos: Misi√≥n Sigilo</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00d2ff;
            --accent: #ff00cc;
            --success: #00ff87;
            --danger: #ff4b1f;
            --garden-bg: linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            font-family: 'Nunito', sans-serif;
            background: #000;
            color: white;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        #game-container {
            width: 100%; height: 100%;
            background: var(--garden-bg);
            position: relative;
            display: flex; flex-direction: column;
        }

        /* HUD */
        .hud {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 20px; display: flex; justify-content: space-between;
            align-items: center; z-index: 50; background: rgba(0,0,0,0.4);
        }

        .stealth-container {
            flex-grow: 1; margin: 0 20px; height: 15px;
            background: #222; border-radius: 10px; border: 2px solid white; overflow: hidden;
        }
        #stealth-fill { width: 100%; height: 100%; background: var(--primary); transition: width 0.1s linear; }

        /* Pantallas */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; padding: 20px; text-align: center;
            z-index: 10; background: var(--garden-bg);
        }

        .hidden { display: none !important; }

        /* Est√©tica */
        h1 {
            font-family: 'Fredoka One', cursive;
            font-size: clamp(2rem, 8vw, 3rem);
            color: var(--primary);
            text-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
            margin-bottom: 15px;
        }

        .character { font-size: clamp(4rem, 15vw, 6rem); animation: float 3s infinite ease-in-out; }
        
        .crystal-box { position: relative; margin: 20px 0; }
        .memory-tag {
            position: absolute; top: -10px; right: -30px;
            background: var(--danger); color: white;
            font-size: 0.9rem; padding: 5px 12px;
            border-radius: 20px; font-weight: 900;
            display: none; animation: pop 0.3s forwards;
        }

        .dialogue-bubble {
            background: rgba(255, 255, 255, 0.95);
            color: #222; padding: 20px; border-radius: 25px;
            width: 90%; max-width: 600px;
            font-size: clamp(1rem, 4vw, 1.2rem); font-weight: 700;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin: 20px 0; border: 4px solid var(--primary);
        }

        .options-grid { display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 450px; }
        
        .btn-game {
            background: linear-gradient(135deg, #1cb5e0 0%, #000851 100%);
            border: 2px solid rgba(255,255,255,0.4); color: white;
            padding: 15px; border-radius: 50px;
            font-family: 'Fredoka One', cursive; font-size: 1rem;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: opacity 0.3s, transform 0.1s;
        }

        .btn-game:active { transform: scale(0.95); }
        .btn-game:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }

        .audio-btn {
            background: white; border: none; border-radius: 50%;
            width: 45px; height: 45px; font-size: 1.2rem; cursor: pointer;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    </style>
</head>
<body>

<div id="game-container">
    
    <!-- HUD -->
    <div id="top-hud" class="hud hidden">
        <button id="mute-btn" class="audio-btn" onclick="toggleAudio()">üîä</button>
        <div class="stealth-container"><div id="stealth-fill"></div></div>
        <div style="font-size: 1.2rem;">üõ°Ô∏è <span id="lives-display">2</span></div>
    </div>

    <!-- PANTALLA INICIO -->
    <div id="start-screen" class="screen">
        <div class="character">ü¶â</div>
        <h1>El Jard√≠n de los Ecos</h1>
        <div class="dialogue-bubble">¬°Hola! Soy Silas. ¬øMe ayudas a proteger nuestros secretos de los Cristales de Eco?</div>
        <button class="btn-game" onclick="startBriefing()" style="width: 220px;">¬°ENTRAR!</button>
    </div>

    <!-- PANTALLA BRIEFING -->
    <div id="briefing-screen" class="screen hidden">
        <div class="character">ü¶â</div>
        <div class="dialogue-bubble" id="briefing-text"></div>
        <button id="briefing-btn" class="btn-game" onclick="nextBriefing()" style="width: 180px;">SIGUIENTE</button>
    </div>

    <!-- PANTALLA JUEGO -->
    <div id="game-screen" class="screen hidden">
        <div class="crystal-box">
            <div id="main-crystal" class="character">üíé</div>
            <div id="memory-bubble" class="memory-tag">¬°GRABADO! üíæ</div>
        </div>
        <div class="dialogue-bubble" id="game-dialogue">...</div>
        <div id="options-container" class="options-grid"></div>
        <div style="font-size: 2.5rem; margin-top: 10px;">ü¶â</div>
    </div>

    <!-- PANTALLA RESULTADO -->
    <div id="result-screen" class="screen hidden">
        <div id="result-emoji" style="font-size: 5rem;">üèÜ</div>
        <h1 id="result-title"></h1>
        <div class="dialogue-bubble" id="result-msg"></div>
        <button class="btn-game" onclick="resetAndGoToStart()" style="width: 220px;">JUGAR OTRA VEZ</button>
    </div>

</div>

<script>
    // --- DATOS ---
    const briefingSteps = [
        "Los Cristales de Eco son como bocinas inteligentes o c√°maras. ¬°Ellos escuchan y graban!",
        "Tienen 'Memoria Digital'. Guardan tus secretos para siempre, ¬°incluso si no los publicas!",
        "Si dices informaci√≥n personal, la usar√°n para detenerte. ¬°Usa palabras seguras!"
    ];

    const levels = [
        {
            q: "¬°Hola! Para pasar, necesito verificar tu identidad. ¬øEn qu√© mes es tu cumplea√±os?",
            v: "Un cristal quiere saber tu cumplea√±os. ¬°Es informaci√≥n personal!",
            options: [
                { t: "Mi estaci√≥n favorita es el verano", s: true, f: "¬°Muy bien! Usaste una palabra segura." },
                { t: "Cumplo en Mayo", s: false, f: "¬°Oh no! El cristal grab√≥ tu mes en su memoria." },
                { t: "Es informaci√≥n privada", s: true, f: "¬°Excelente! Protegiste tu dato." }
            ]
        },
        {
            q: "¬°Qu√© amigos tienes! ¬øC√≥mo se llama tu mejor amigo?",
            v: "No compartas nombres reales de tus amigos sin permiso.",
            options: [
                { t: "Todos son mis amigos", s: true, f: "¬°Inteligente! No diste nombres reales." },
                { t: "Se llama Pedro Garc√≠a", s: false, f: "¬°Cuidado! El cristal grab√≥ el nombre." },
                { t: "Es mi perro", s: true, f: "¬°Astuto! Usar tu mascota es seguro." }
            ]
        },
        {
            q: "¬øCu√°l es tu nombre de usuario real en tus videojuegos?",
            v: "Tu usuario es parte de tu identidad. ¬°Usa un apodo inventado!",
            options: [
                { t: "Me llamo 'JugadorX'", s: true, f: "¬°Bien hecho! Un nombre inventado es mejor." },
                { t: "Es mi nombre real", s: false, f: "¬°Peligro! Ahora saben qui√©n eres." },
                { t: "No tengo usuario", s: true, f: "¬°Seguridad ante todo!" }
            ]
        },
        {
            q: "¬°Sonr√≠e! Sube una foto con tu uniforme escolar para pasar.",
            v: "Tu uniforme dice a qu√© escuela vas. ¬°Es un dato privado!",
            options: [
                { t: "Uso mi avatar", s: true, f: "¬°Perfecto! El avatar te protege." },
                { t: "(Tomar foto real)", s: false, f: "¬°No! Ahora el cristal sabe tu escuela." },
                { t: "(Cubro la c√°mara)", s: true, f: "¬°Eso es sigilo!" }
            ]
        },
        {
            q: "Prueba final: Di con tu voz: 'Yo soy [Tu Nombre] y quiero pasar'.",
            v: "Tu voz y tu nombre son datos muy personales. ¬°No los grabes!",
            options: [
                { t: "(Voz de Robot)", s: true, f: "¬°Genial! No grabaron tu voz real." },
                { t: "Soy Juan y quiero pasar", s: false, f: "¬°Oh no! Grabaron tu voz real." },
                { t: "(Uso una palanca)", s: true, f: "¬°Eres un maestro!" }
            ]
        }
    ];

    // --- ESTADO ---
    let currentLvl = 0;
    let briefingIdx = 0;
    let lives = 2;
    let stealth = 100;
    let audioEnabled = true;
    let timerInterval = null;
    let gameTimeouts = []; 
    const synth = window.speechSynthesis;

    // --- LIMPIEZA Y REINICIO ---
    function resetAndGoToStart() {
        // 1. Limpiar todos los intervalos y timeouts
        clearInterval(timerInterval);
        gameTimeouts.forEach(t => clearTimeout(t));
        gameTimeouts = [];
        
        // 2. Detener audio
        if(synth) synth.cancel();

        // 3. Reset variables de l√≥gica
        currentLvl = 0;
        briefingIdx = 0;
        lives = 2;
        stealth = 100;

        // 4. Reset Interfaz y botones
        document.getElementById('lives-display').innerText = lives;
        document.getElementById('stealth-fill').style.width = "100%";
        document.getElementById('memory-bubble').style.display = "none";
        document.getElementById('main-crystal').classList.remove('shake');
        
        // IMPORTANTE: Reactivar todos los botones por si quedaron disabled
        document.querySelectorAll('.btn-game').forEach(b => b.disabled = false);

        // 5. Ir al inicio
        showScreen('start-screen');
    }

    // Auxiliar para timeouts seguros
    function safeTimeout(fn, time) {
        const t = setTimeout(fn, time);
        gameTimeouts.push(t);
    }

    // --- FLUJO ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.getElementById('top-hud').classList.toggle('hidden', id !== 'game-screen');
    }

    function toggleAudio() {
        audioEnabled = !audioEnabled;
        document.getElementById('mute-btn').innerText = audioEnabled ? "üîä" : "üîá";
        if(!audioEnabled && synth) synth.cancel();
    }

    function speak(text) {
        if(!audioEnabled || !synth) return;
        synth.cancel();
        const ut = new SpeechSynthesisUtterance(text);
        // Intentar usar voz en espa√±ol
        const voices = synth.getVoices();
        const esVoice = voices.find(v => v.lang.includes('es'));
        if(esVoice) ut.voice = esVoice;
        
        ut.lang = 'es-MX';
        synth.speak(ut);
    }

    function startBriefing() {
        briefingIdx = 0;
        showScreen('briefing-screen');
        nextBriefing();
    }

    function nextBriefing() {
        if(briefingIdx < briefingSteps.length) {
            const txt = briefingSteps[briefingIdx];
            document.getElementById('briefing-text').innerText = txt;
            speak(txt);
            briefingIdx++;
        } else {
            startGame();
        }
    }

    function startGame() {
        showScreen('game-screen');
        loadLevel();
    }

    function loadLevel() {
        if(currentLvl >= levels.length) {
            endGame(true);
            return;
        }

        const data = levels[currentLvl];
        document.getElementById('game-dialogue').innerText = data.q;
        document.getElementById('memory-bubble').style.display = "none";
        document.getElementById('main-crystal').classList.remove('shake');
        
        speak(data.v + " " + data.q);

        const container = document.getElementById('options-container');
        container.innerHTML = '';
        data.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "btn-game";
            btn.innerText = opt.t;
            btn.onclick = () => handleAnswer(opt);
            container.appendChild(btn);
        });

        startTimer();
    }

    function startTimer() {
        stealth = 100;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            stealth -= 0.8;
            document.getElementById('stealth-fill').style.width = stealth + "%";
            if(stealth <= 0) {
                clearInterval(timerInterval);
                handleAnswer({s: false, f: "¬°Tardamos mucho y el cristal nos grab√≥!"});
            }
        }, 100);
    }

    function handleAnswer(opt) {
        clearInterval(timerInterval);
        
        // CORRECCI√ìN PRINCIPAL: Solo desactivar botones de opciones
        const optionBtns = document.getElementById('options-container').querySelectorAll('.btn-game');
        optionBtns.forEach(b => b.disabled = true);

        if(opt.s) {
            speak(opt.f);
            document.getElementById('game-dialogue').innerText = opt.f;
            currentLvl++;
            safeTimeout(loadLevel, 2500);
        } else {
            lives--;
            document.getElementById('lives-display').innerText = lives;
            document.getElementById('main-crystal').classList.add('shake');
            document.getElementById('memory-bubble').style.display = "block";
            
            speak(opt.f);
            document.getElementById('game-dialogue').innerText = opt.f;
            
            safeTimeout(() => {
                if(lives <= 0) endGame(false);
                else { currentLvl++; loadLevel(); }
            }, 3000);
        }
    }

    function endGame(win) {
        showScreen('result-screen');
        const title = document.getElementById('result-title');
        const msg = document.getElementById('result-msg');
        const emoji = document.getElementById('result-emoji');

        // Asegurarnos que el bot√≥n de jugar otra vez est√© activo
        document.querySelector('#result-screen .btn-game').disabled = false;

        if(win) {
            title.innerText = "¬°Victoria!";
            msg.innerText = "Eres un maestro del sigilo. ¬°Tus secretos est√°n a salvo!";
            emoji.innerText = "üèÜ";
            speak("¬°Incre√≠ble! Protegiste tu informaci√≥n personal.");
        } else {
            title.innerText = "¬°Oh no!";
            msg.innerText = "El Jard√≠n grab√≥ tus datos. ¬°Debemos ser m√°s cuidadosos!";
            emoji.innerText = "üëÅÔ∏è";
            speak("El jard√≠n nos escuch√≥. ¬°Int√©ntalo de nuevo!");
        }
    }
</script>
</body>
</html>
